name: Firebase Auto-Deploy (pnpm)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      ########################################################################
      # 第一步：拉取代码
      ########################################################################
      - name: Checkout repository code
        uses: actions/checkout@v4

      ########################################################################
      # 第二步：配置Node.js环境（必须在pnpm安装前）
      ########################################################################
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'pnpm'  # 缓存pnpm依赖

      ########################################################################
      # 第三步：安装pnpm（显式设置路径，确保后续步骤能找到）
      ########################################################################
      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8
          run_install: false  # 不自动安装依赖，我们手动控制

      ########################################################################
      # 验证pnpm是否安装成功（新增步骤，确保pnpm可用）
      ########################################################################
      - name: Verify pnpm installation
        run: |
          pnpm --version  # 打印版本号，确认安装成功
          echo "PNPM_HOME=$PNPM_HOME" >> $GITHUB_ENV  # 显式设置环境变量
          echo "$PNPM_HOME" >> $GITHUB_PATH  # 添加到PATH

      ########################################################################
      # 第四步：安装项目依赖（现在pnpm已在PATH中）
      ########################################################################
      - name: Install project dependencies
        run: pnpm install

      ########################################################################
      # 第五步：执行构建
      ########################################################################
      - name: Build project
        run: pnpm run build

      ########################################################################
      # 第六步：安装Firebase CLI
      ########################################################################
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      ########################################################################
      # 第七步：Firebase认证
      ########################################################################
      - name: Authenticate with Firebase
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "$FIREBASE_SERVICE_ACCOUNT" > firebase-credentials.json
          firebase login:ci --service-account firebase-credentials.json
          firebase use xy-level-calc --token $(cat ~/.config/firebase/cli.json | jq -r .tokens.ci)
          rm -f firebase-credentials.json

      ########################################################################
      # 第八步：部署到Firebase
      ########################################################################
      - name: Deploy to Firebase Hosting
        run: |
          FIREBASE_TOKEN=$(cat ~/.config/firebase/cli.json | jq -r .tokens.ci)
          firebase deploy \
            --only hosting \
            --project xy-level-calc \
            --public dist \
            --non-interactive \
            --token $FIREBASE_TOKEN
