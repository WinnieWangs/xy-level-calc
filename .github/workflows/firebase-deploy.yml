# .github/workflows/firebase-deploy.yml
name: Firebase Auto-Deploy (pnpm)

# è§¦å‘æ¡ä»¶ï¼šå½“ä»£ç æ¨é€åˆ° main åˆ†æ”¯ï¼ˆå¯æ ¹æ®éœ€æ±‚ä¿®æ”¹åˆ†æ”¯åï¼Œå¦‚ dev/testï¼‰
on:
  push:
    branches:
      - main  # ç›‘å¬çš„åˆ†æ”¯ï¼Œå»ºè®®ç”Ÿäº§ç¯å¢ƒç”¨ mainï¼Œæµ‹è¯•ç¯å¢ƒç”¨ dev

jobs:
  build-and-deploy:
    # è¿è¡Œç¯å¢ƒï¼šæœ€æ–°ç‰ˆ Ubuntuï¼ˆå…¼å®¹æ€§å¥½ï¼Œé€Ÿåº¦å¿«ï¼‰
    runs-on: ubuntu-latest

    steps:
      ########################################################################
      # ç¬¬ä¸€æ­¥ï¼šæ‹‰å– GitHub ä»“åº“ä»£ç 
      ########################################################################
      - name: Checkout repository code
        uses: actions/checkout@v4  # å®˜æ–¹åŠ¨ä½œï¼Œæ‹‰å–å½“å‰åˆ†æ”¯ä»£ç 

      ########################################################################
      # ç¬¬äºŒæ­¥ï¼šé…ç½® Node.js ç¯å¢ƒï¼ˆpnpm ä¾èµ– Node.jsï¼‰
      ########################################################################
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20  # é€‰æ‹©ä¸æœ¬åœ°å¼€å‘ä¸€è‡´çš„ Node ç‰ˆæœ¬ï¼ˆå»ºè®® 18+ï¼‰
          cache: 'pnpm'     # ç¼“å­˜ pnpm ä¾èµ–ï¼ŒåŠ é€Ÿåç»­æ„å»ºï¼ˆå…³é”®ä¼˜åŒ–ï¼‰

      ########################################################################
      # ç¬¬ä¸‰æ­¥ï¼šå®‰è£… pnpm åŒ…ç®¡ç†å™¨ï¼ˆUbuntu é»˜è®¤æ²¡æœ‰ pnpmï¼Œéœ€æ‰‹åŠ¨å®‰è£…ï¼‰
      ########################################################################
      - name: Install pnpm
        uses: pnpm/action-setup@v3  # pnpm å®˜æ–¹åŠ¨ä½œï¼Œç¡®ä¿ç‰ˆæœ¬ä¸€è‡´
        with:
          version: 8  # é€‰æ‹©ç¨³å®šçš„ pnpm ç‰ˆæœ¬ï¼ˆä¸æœ¬åœ°ä½¿ç”¨çš„ç‰ˆæœ¬åŒ¹é…ï¼‰

      ########################################################################
      # ç¬¬å››æ­¥ï¼šå®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆåŸºäº package.jsonï¼‰
      ########################################################################
      - name: Install project dependencies
        run: pnpm install  # æ›¿ä»£ npm installï¼Œä½¿ç”¨ pnpm å®‰è£…ä¾èµ–

      ########################################################################
      # ç¬¬äº”æ­¥ï¼šæ‰§è¡Œé¡¹ç›®æ„å»ºï¼ˆpnpm run buildï¼‰
      ########################################################################
      - name: Build project (pnpm run build)
        run: pnpm run build  # æ‰§è¡Œä½ çš„æ„å»ºå‘½ä»¤ï¼Œç”Ÿæˆç”Ÿäº§ç¯å¢ƒæ–‡ä»¶
       

      ########################################################################
      # ç¬¬å…­æ­¥ï¼š Firebase èº«ä»½éªŒè¯ï¼ˆé€šè¿‡æœåŠ¡è´¦æˆ·å¯†é’¥ï¼Œå®‰å…¨æ— äº¤äº’ï¼‰
      ########################################################################
      - name: Authenticate with Firebase
        uses: FirebaseExtended/action-firebase-login@v3  # Firebase å®˜æ–¹ç™»å½•åŠ¨ä½œ
        with:
          # å¼•ç”¨ GitHub Secrets ä¸­å­˜å‚¨çš„ Firebase æœåŠ¡è´¦æˆ·å¯†é’¥
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}
          # ï¼ˆé‡è¦ï¼‰æ›¿æ¢ä¸ºä½ çš„ Firebase é¡¹ç›® IDï¼ˆåœ¨ Firebase æ§åˆ¶å° â†’ é¡¹ç›®è®¾ç½® ä¸­æŸ¥çœ‹ï¼‰
          projectId: xy-level-calc

      ########################################################################
      # ç¬¬ä¸ƒæ­¥ï¼šéƒ¨ç½²æ„å»ºåçš„æ–‡ä»¶åˆ° Firebase Hosting
      ########################################################################
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0  # Firebase å®˜æ–¹éƒ¨ç½²åŠ¨ä½œ
        with:
          # ï¼ˆå…³é”®ï¼‰æŒ‡å®šæ„å»ºåçš„è¾“å‡ºç›®å½•ï¼ˆæ ¹æ®ä½ çš„é¡¹ç›®å®é™…ç›®å½•ä¿®æ”¹ï¼ï¼‰
          # å¸¸è§æ¡†æ¶ç›®å½•ï¼šVue/Vite æ˜¯ distï¼ŒReact æ˜¯ buildï¼Œéœ€ä¸æœ¬åœ°æ„å»ºç»“æœä¸€è‡´
          folder: dist  # ğŸ”” è¯·ç¡®è®¤ä½ çš„æ„å»ºè¾“å‡ºç›®å½•ï¼Œè‹¥ä¸º build åˆ™æ”¹ä¸º folder: build
          # éƒ¨ç½²ç›®æ ‡ï¼ˆé»˜è®¤éƒ¨ç½²åˆ° "live" ç¯å¢ƒï¼Œå³ç”Ÿäº§ç¯å¢ƒï¼‰
          channelId: live
          # è‡ªåŠ¨æ¸…ç†æ—§ç‰ˆæœ¬ï¼ˆå¯é€‰ï¼Œä¿æŒå­˜å‚¨æ•´æ´ï¼‰
          cleanup: true
        env:
          # è‡ªåŠ¨ä½¿ç”¨ä¸Šä¸€æ­¥çš„ç™»å½•èº«ä»½ï¼Œæ— éœ€é¢å¤–é…ç½®
          FIREBASE_CLI_PREVIEWS: hostingchannels  # å¯ç”¨ Hosting æ¸ é“åŠŸèƒ½